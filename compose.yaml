# SPDX-FileCopyrightText: 2025 Magenta ApS <https://magenta.dk>
# SPDX-License-Identifier: AGPL-3.0-only

# Docker compose file used only for development in OpenStream
x-env-openstream: &env-openstream ./dev-environment/backend/openstream.env
x-env-keycloak: &env-keycloak ./dev-environment/keycloak/keycloak.env
x-env-frontend: &env-frontend ./dev-environment/frontend/frontend.env

x-common-networks: &common-networks
  - openstream_net

networks:
  openstream_net:

volumes:
  openstream_db:

services:
  openstream:
    container_name: openstream
    build:
      context: ./backend
      dockerfile: docker/Dockerfile
      target: development
      args:
        INSTALL_DEV_DEPS: "true"
    image: openstreamadminsite
    pull_policy: never
    env_file:
      - *env-openstream
      - .env
    networks: *common-networks
    ports:
      - 8000:8000
    volumes:
      - ./backend/openstream/project:/app/project:Z
      - ./backend/openstream/app:/app/app:Z
      - ./backend/openstream/sso:/app/sso:Z
      - ./backend/openstream/osauth:/app/osauth:Z
      - ./backend/locale:/app/locale:Z
      - ./dev-environment/backend/fixtures:/app/fixtures:Z
    depends_on:
      - db

  db:
    container_name: openstream-db
    # Specify docker repo for Podman compatibility
    image: docker.io/library/postgres:17
    env_file:
      - *env-openstream
      - *env-keycloak
    networks: *common-networks
    volumes:
      - openstream_db:/var/lib/postgresql/data:Z
      - ./dev-environment/backend/initdb.sh:/docker-entrypoint-initdb.d/initdb.sh:ro,Z

  cron:
    container_name: openstream-cron
    image: openstreamadminsite
    pull_policy: never
    env_file:
      - *env-openstream
    networks: *common-networks
    volumes:
      - ./backend/openstream/project:/app/project:Z
      - ./backend/openstream/app:/app/app:Z
      - ./backend/openstream/sso:/app/sso:Z
    entrypoint: [ "/usr/local/bin/supercronic", "/crontab" ]
    depends_on:
      - openstream

  keycloak:
    container_name: openstream-keycloak
    image: docker.io/magentaaps/openstream-keycloak:0.2.5
    entrypoint: ["/opt/keycloak/bin/kc.sh", "start-dev", "--import-realm"]
    env_file:
      - *env-keycloak
    networks: *common-networks
    ports:
      - 8080:8080
    volumes:
      - ./dev-environment/keycloak/realms:/opt/keycloak/data/import
    depends_on:
      - db

  frontend:
    container_name: openstream-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: ${DEPLOYMENT_MODE:-development}
    image: openstreamadminsite-frontend
    pull_policy: never
    env_file:
      - *env-frontend
    networks: *common-networks
    ports:
      - "5173:5173"  # Development port
      - "4173:80"    # Production port (nginx internal port 80)
    volumes:
      # Only mount source code in development mode
      - ./frontend/src:/app/src:Z
      - ./frontend/public:/app/public:Z
      - ./frontend/vite.config.js:/app/vite.config.js:Z
    depends_on:
      - openstream
  media_converter:
    container_name: openstream-media-converter
    build:
      context: ./media_converter_service
      dockerfile: Dockerfile
    image: openstream-media-converter
    pull_policy: never
    networks: *common-networks
    ports:
      - "8001:8000"
    volumes:
      - ./media_converter_service:/app:Z
    depends_on:
      - openstream

  minio:
    container_name: openstream-minio
    image: docker.io/minio/minio:latest
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    networks: *common-networks
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./dev-environment/minio/data:/data:Z
    command: server /data --console-address ":9001"
    # ADD THIS HEALTHCHECK SECTION
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ADD THIS NEW SERVICE
  minio-init:
    image: docker.io/minio/mc
    depends_on:
      minio:
        condition: service_healthy # Waits for the healthcheck to pass
    networks: *common-networks
    entrypoint: /bin/sh
    command: -c "/scripts/minio-init.sh"
    volumes:
      - ./minio-init.sh:/scripts/minio-init.sh:Z
