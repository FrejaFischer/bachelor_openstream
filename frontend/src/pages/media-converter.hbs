<section class="page media-converter">
  <h1>Media Converter</h1>

  <form id="convert-form">
    <label for="type">Type</label>
    <select id="type" name="type">
      <option value="image">Image</option>
      <option value="video">Video</option>
    </select>

    <label for="file">File</label>
    <input id="file" name="file" type="file" required />

    <button type="submit">Upload & Convert</button>
  </form>

  <div id="status"></div>
  <div id="status"></div>

  <script type="module">
    // Import the constants module via the built frontend path. Depending on
    // build tool the actual import path may differ; this assumes the
    // development server exposes modules from /src.
    import { CONVERTER_BASE } from '/src/assets/utils/constants.js';

    // Expose to window for non-module parts of the page
    window.MEDIA_CONVERTER_BASE = CONVERTER_BASE;

    const form = document.getElementById('convert-form');
    const status = document.getElementById('status');

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      status.textContent = 'Uploading...';

      const fileInput = document.getElementById('file');
      const type = document.getElementById('type').value;
      if (!fileInput.files.length) {
        status.textContent = 'Choose a file';
        return;
      }

      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('file', file, file.name);

      try {
        const endpoint = (type === 'image') ? '/convert/image' : '/convert/video';
        const base = window.MEDIA_CONVERTER_BASE || ('http://localhost:8001');
        const res = await fetch(base + endpoint, {
          method: 'POST',
          body: formData
        });

        if (!res.ok) {
          const txt = await res.text();
          status.textContent = `Error: ${res.status} ${txt}`;
          return;
        }

        // Determine file extension
        const contentType = res.headers.get('content-type') || '';
        const ext = contentType.startsWith('image/') ? '.webp' : (contentType.startsWith('video/') ? '.mp4' : '');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'converted' + ext;
        a.textContent = 'Download converted file';
        a.style.display = 'block';

        status.textContent = '';
        status.appendChild(a);
      } catch (err) {
        status.textContent = 'Upload failed: ' + err.message;
      }
    });
  </script>
</section>
